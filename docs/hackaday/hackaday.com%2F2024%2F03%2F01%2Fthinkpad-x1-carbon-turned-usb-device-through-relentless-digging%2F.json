{"pubDate": "2024-03-01T12:00:38", "original_title": "ThinkPad X1 Carbon Turned USB Device Through Relentless Digging", "link": "https://hackaday.com/2024/03/01/thinkpad-x1-carbon-turned-usb-device-through-relentless-digging/", "source": "https://hackaday.com/blog/feed/", "thumbnail": "https://hackaday.com/wp-content/uploads/2024/02/hadimg_thinkpad_xhci_feat.jpg", "original_content": "In whats perhaps one of the most impressive laptop reverse engineering posts in recent memory, [Andrey Konovalov] brings us an incredibly detailed story of how hes discovered and successfully enabled a USB device controller in a ThinkPad X1 Carbon equipped with a 6th gen Intel CPU.\nIf you ever wanted to peek at the dirty secrets of a somewhat modern-day Intel CPU-based system, this write-up spares you no detail, and spans dozens of abstraction layers  from Linux drivers and modifying NVRAM to custom USB cable building and BIOS chip flashing, digging deep into undocumented PCH registers for the dessert.\nAll [Andrey] wanted was to avoid tinkering with an extra Raspberry Pi. While using a PCIe connected device controller, hes found a reference to intel_xhci_usb_sw-role-switch in Linux sysfs, and dove into a rabbit hole, where he discovered that the IP core used for the laptops USB ports has a device mode that can be enabled. A dig through ACPI tables confirmed this, but also highlighted that the device is disabled in BIOS. Whats more, it turned out to be locked away behind a hidden menu. Experiments in unlocking that menu ensued, in particular when it comes to bypassing Intel Boot Guard, a mechanism that checks BIOS image signatures before boot.\n\nAn SPI socket [Andrey] got on Adafruit for ease of patching the BIOS to unlock the hidden menu[Andrey] shows us a few different ways hes tried to enable the controller, just for the fun of it, from using BootGuard exploits to reverse-engineering NVRAM EFI variable mapping, and even a lengthy section on poking directly at the Intel PCHs registers trying to enable the USB device peripheral from userspace, assisted by [Maxim Goryachy] of Intel reverse-engineering fame. In the end, the NVRAM patching way turned out to be the most viable way for an average user, and the blog post has more than enough detail for any enterprising hacker who would like to make it work for them as well.\nAs a victory dance, we get a section on all the wonderful things you can do if your device supports USB device mode. Theres the obvious USB storage example, but [Alexey] shows us a few cool tools to remember  the Raw Gadget Linux kernel framework for building any kind of USB device you could dream of, the syzkaller USB stack fuzzer, and Facedancer, a framework for USB device emulation.\nIf you think all of this is a lot, mind you that we have only described about half of all the cool stuff that the blog post contains  you should go check it out, and make a cup of tea, because theres just that much cool stuff to learn about.\nGenuinely, this blog post is a testament to a hackers dedication, and a shining example of just how far you can reach if you are willing to keep digging. Does your laptop hide some secrets that nobody knew existed? Remember, theres only one way to find out.", "title": "ThinkPad X1 Carbon\u306eUSB\u30b5\u30a6\u30f3\u30c9\u30e2\u30fc\u30c9\u3092\u6709\u52b9\u5316\u3059\u308b\u65b9\u6cd5", "body": "\u30e9\u30c3\u30d7\u30c8\u30c3\u30d7\u306e\u30ea\u30d0\u30fc\u30b9\u30a8\u30f3\u30b8\u30cb\u30a2\u30ea\u30f3\u30b0\u306b\u6210\u529f\u3057\u305f[Andrey Konovalov]\u304c\u3001ThinkPad X1 Carbon\u3067USB\u30c7\u30d0\u30a4\u30b9\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u3092\u6709\u52b9\u5316\u3057\u305f\u7269\u8a9e\u3092\u8a73\u7d30\u306b\u7d39\u4ecb\u3002BIOS\u306e\u5909\u66f4\u3084\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u306e\u89e3\u6790\u304b\u3089Linux\u30c9\u30e9\u30a4\u30d0\u307e\u3067\u3001\u591a\u5c90\u306b\u308f\u305f\u308b\u4f5c\u696d\u3068\u672a\u516c\u958b\u306e\u6280\u8853\u306b\u6311\u6226\u3002_USB\u30c7\u30d0\u30a4\u30b9\u30e2\u30fc\u30c9\u3092\u6d3b\u7528\u3059\u308b\u65b9\u6cd5\u3082\u7d39\u4ecb\u3002", "titles": ["ThinkPad X1 Carbon\u306eUSB\u30b5\u30a6\u30f3\u30c9\u30e2\u30fc\u30c9\u3092\u6709\u52b9\u5316\u3059\u308b\u65b9\u6cd5", "\u30a4\u30f3\u30c6\u30ebCPU\u30d9\u30fc\u30b9\u30b7\u30b9\u30c6\u30e0\u306eUSB\u30b3\u30f3\u30c8\u30ed\u30fc\u30e9\u30fc\u3092\u6709\u52b9\u5316\u3059\u308b\u65b9\u6cd5", "\u30e2\u30c0\u30f3\u306aIntel CPU\u30b7\u30b9\u30c6\u30e0\u306e\u96a0\u3055\u308c\u305fUSB\u30e2\u30fc\u30c9\u3092\u89e3\u9664\u3059\u308b", "\u30d0\u30a4\u30aa\u30b9\u306e\u96a0\u3057\u30e1\u30cb\u30e5\u30fc\u304b\u3089USB\u30dd\u30fc\u30c8\u3092\u6709\u52b9\u5316\u3059\u308b\u65b9\u6cd5", "USB\u30c7\u30d0\u30a4\u30b9\u30e2\u30fc\u30c9\u3092\u6d3b\u7528\u3057\u305f\u30af\u30ea\u30a8\u30a4\u30c6\u30a3\u30d6\u306a\u30d7\u30ed\u30b8\u30a7\u30af\u30c8\u30a2\u30a4\u30c7\u30a2"]}