{"pubDate": "2023-09-20T17:00:18", "original_title": "Button, Button, Who\u2019s Got the (Pico) Button?", "link": "https://hackaday.com/2023/09/20/button-button-whos-got-the-pico-button/", "source": "https://hackaday.com/blog/feed/", "thumbnail": "https://hackaday.com/wp-content/uploads/2021/05/DSCF2222_featured.png", "original_content": "There is an episode of Ren and Stimpy with a big red history eraser button that must not be pressed. Of course, who can resist the temptation of pressing the unpressable button? The same goes for development boards. If there is a button on there, you want to read it in your code, right? The Raspberry Pi Pico is a bit strange in that regard. The standard one lacks a reset button, but there is a big tantalizing button to reset in bootloader mode. You only use it when you power up, so why not read it in your code? Why not, indeed?\nTurns out, that button isnt what you think it is. It isnt connected to a normal CPU pin at all. Instead, it connects to the flash memory chip. So does that mean you cant read it at all? Not exactly. Theres good news, and then theres bad news.\nThe Good News\nThe official Raspberry Pi examples show how to read the button (you have read all the examples, right?). You can convert the flashs chip-select into an input temporarily and try to figure out if the pin is low, meaning that the button is pushed. Sounds easy, right?\n\nThe Bad News\nThe bad news is really bad. When you switch the flash chip-select to an input, you will lose access to the flash memory. But we are running from the flash memory! So, the first thing to think about is that the code will need to run from RAM.\nBut thats not all. The Pico has interrupts and two CPU cores. So even if you are out of the flash memory, theres no reason to assume someone else wont want to use it simultaneously. So, to make this work, you need to disable interrupts and shut down the other CPU core while you read the pin.\nThe Example\nLooking at the example, they do everything but disable the second core. I recently had to put this code in an Arduino-style program; there is excellent Arduino support for the Pico. Putting the function in RAM is pretty easy:\n\nbool __no_inline_not_in_flash_func(_get_bootsel_button)() {\n\nThe rest is just manipulating the I/O pins and turning interrupts on and off:\n\nuint32_t flags = save_and_disable_interrupts();\n\n// Set chip select to Hi-Z\nhw_write_masked(ioqspi_hw-io[CS_PIN_INDEX].ctrl,\nGPIO_OVERRIDE_LOW  IO_QSPI_GPIO_QSPI_SS_CTRL_OEOVER_LSB,\nIO_QSPI_GPIO_QSPI_SS_CTRL_OEOVER_BITS);\n\n// Note we can't call into any sleep functions in flash right now\nfor (volatile int i = 0; i 1000; ++i);\n\n// The HI GPIO registers in SIO can observe and control the 6 QSPI pins.\n// Note the button pulls the pin *low* when pressed.\nbool button_state = !(sio_hw-gpio_hi_in  (1u  CS_PIN_INDEX));\n\n// Need to restore the state of chip select, else we are going to have a\n// bad time when we return to code in flash!\nhw_write_masked(ioqspi_hw-io[CS_PIN_INDEX].ctrl,\nGPIO_OVERRIDE_NORMAL  IO_QSPI_GPIO_QSPI_SS_CTRL_OEOVER_LSB,\nIO_QSPI_GPIO_QSPI_SS_CTRL_OEOVER_BITS);\n\nrestore_interrupts(flags);\n\nThat leaves the core. I put a wrapper around this function to avoid any possible problems with it being called from RAM (though it would probably work):\n\nbool get_bootsel_button(void)\n{\n   bool rv;\n// freeze\n   rp2040.idleOtherCore();\n   rv = _get_bootsel_button();\n// unfreeze\n   rp2040.resumeOtherCore();\n   return rv;\n}\n\nIt works. But I do worry about how inefficient it must be. You usually want to poll a button often. Turning off the other core, disabling interrupts, and the idle loop to let the pin settle  all that will take time. In practice, it seems to work OK, but it must be slowing things down some.\nIn Retrospect\nSo, can you read the Pico button? Yes. Should you? Maybe. For some applications, it is probably just fine. But if you are worried about performance, it probably isnt the best idea.\nWith two 133 MHz cores, a ton of memory, easy debugging, and those cool peripheral processors, theres a lot to love about the Pico. Just maybe not the BOOTSEL button.\n"}