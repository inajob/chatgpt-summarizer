{"pubDate": "2023-07-25T14:00:12", "original_title": "PCIe For Hackers: Our M.2 Card Is Done", "link": "https://hackaday.com/2023/07/25/pcie-for-hackers-our-m-2-card-is-done/", "source": "https://hackaday.com/blog/feed/", "thumbnail": "https://hackaday.com/wp-content/uploads/2023/03/PCIe.jpg", "original_content": "Weve started designing a PCIe card last week, an adapter from M.2 E-key to E-key, that adds an extra link to the E-key slot it carries  useful for fully utilizing a few rare but fancy E-key cards. By now, the schematic is done, the component placement has been figured out, and we only need to route the differential pairs  should be simple, right? Buckle up.\nGetting Diffpairs Done\nPCIe needs TX pairs connected to RX on another end, like UART  and this is non-negotiable. Connectors will use host-side naming, and vice-versa. As the diagram demonstrates, we connect the sockets TX to chips RX and vice-versa; if we ever get confused, the laptop schematic is there to help us make things clear. To sum up, we only need to flip the names on the link coming to the PCIe switch, since the PCIe switch acts as a device on the card; the two links from the switch go to the E-key socket, and for that sockets purposes, the PCIe switch acts as a host.\nWhile initially routing this board, I absolutely forgot about one more important thing for PCIe  series capacitors on every data pair, on the host TX side of the link. We need three capacitor pairs here  on TX of the PCIe switch uplink, and two pairs on TX side of the switch  again, naming is host-side. I only remembered this after having finished routing all the diffpairs, and, after a bit of deliberation, I decided that this is my chance to try 0201 capacitors. For that, I took the footprints from [Christoph]s wonderful project, called Effect of moon phase on tombstoning  with such a name, these footprints have got to be good.\nWeve talked about differential pair calculations before in one of the PCIe articles, and there was a demo video too! That said, lets repeat the calculations on this one  Ill show how to get from PCB fab website information to proper width and clearance diffpairs, with a few fun shortcuts. Our setup is, once again, having signals on outer layers, referenced to the ground layer right below them. I, sadly, dont yet understand how to calculate differential impedance for signal layers sandwiched between two ground planes, which is to say  if theres any commenters willing to share this knowledge, Id appreciate your input tremendously! For now, I dont see that thered be a tangible benefit to such an arrangement, anyway.\n\nDifferent Stackup Might Help\nThis time, Im going with a 4-layer 0.8 mm stackup  otherwise the board wont fit into an M.2 socket. According to the design rules, I can go down to 3.5 mil (0.09 mm) traces and spacings, as opposed to the usual 6 mil (0.16 mm) traces Im used to when doing generic 2-layer boards. Initially, Im choosing the 7628 stackup variant here  the main difference between stackups here is the prepreg thickness and the dielectric constant, which impacts minimum possible diffpair thickness and spacing.\nI went by parameters on the JLCPCB stackup page, and took via parameters from the ordering page  you can put these parameters into the File = Board Setup window, in the Net Classes tab. After replacing the default parameters there with the 4-layer impedance controlled process ones  clearance, minimum trace width, via size and such,  we get some pretty lovely parameters that we can drop down to if theres ever a tight spot, and an ability to do reasonably dense component placement.\nLets aim for on-point 85 ohm differential impedance today  a great target wherever you can afford it. Again, traces on top, uninterrupted ground plane right under them, along the entire length of the pairs. For 7628 stackup, that means theres 0.21 mm of material with 4.6 Er between the pairs and the ground  punch these two values into the calculator, leave copper thickness at 35 um (1oz copper), and we can play around with trace space and width values, down to our 0.09 mm limit  which leads us to a 0.225 mm width / 0.09 mm space option. This isnt all that great space-wise, however.\nYou dont have to stick with the default stackup, though! After little deliberation, I switched to the 3313 stackup  with 4.05 Er and 0.1 mm thick prepreg between top and middle layers. It seems to be a tad more expensive, but it does look a bit easier to route in the small amount of space that I have. This led me to 0.135 mm / 0.09 mm pairs, while keeping the same 85 ohms differential impedance. Now, all I need to do is to enter these parameters into the Net Classes table, and whenever I press 6, Ill immediately start drawing a 85 ohm impedance differential pair.\nDiffpair Drawing\nThe IC is placed, the diffpair parameters are tuned  we can start drawing. Remember, flipping the PCIe pair polarity isnt a crime, its an obligation to make routing easier on yourself. Somehow, in this design it wasnt needed even once.\nYou do, however, need a bit of patience  KiCads differential pair drawing experience isnt always smooth; if youre having weird problems where one end of the pair doesnt quite connect to another end, youre not alone. For me, drawing these pairs was a tad infuriating. Its conceivable that what Im dealing with something commonly referred to as a skill issue  perhaps, theres a setting Im not noticing, as sometimes such does not connect problems are caused by DRC constraints. However, in that case, there will be a warning shown to you on the bar above.\nRemember, whenever your diffpair crosses from top to bottom layer or vice-versa, it also changes reference layers, from In1 to In2 respectively  and youll want to add ground vias near the diffpair vias, so that the ground return current can travel along the pair, too. As usual, four vias are ideal, three are good, two are okay, and one is non-ideal but better than zero.\nOnce weve drawn diffpairs and added ground vias, theres one last thing to take care of. While PCIe pairs dont have to all be the same length, the two traces that each pair consists of, do have to be the same end to end. For that, you can use the differential pair skew correction tool  mapped to 9 on the keyboard. It will add a wiggle to the longer track, in the spot where a wiggle would fit best.\nAll The Layers\nWhen drawing boards, you can often use one GND and one VCC internal layer  as technically, both VCC and GND can be used as reference planes for high-speed signals. However, since were crossing diffpairs between top and bottom layers, they would then have different references, and this is still unexplored territory for me  Im not sure whether thered be return current problems. Ive started out with one 1.2 V and one GND internal plane, but afterwards, as I was sanity-checking my boards and writing this article, I talked with other engineers, re-read an interesting comment thread under the first PCIe diffpair article, and decided to switch to having both internal planes as GND.\nWhen it comes to the outer layers where diffpairs go, youll want to remove the ground fill or move it away, so that the ground fill around the pair will affect the diffpairs impedance  you are highly likely see a ground keepout if you take a look at any PCIe card you own. Here, I am going to route diffpairs on the outer layers, but Im not not going to completely remove ground on these, using keepouts instead. First off, having ground is cool  its extra copper that can help dissipate heat from the switch, or the switching regulator, or both. Second thing is  JLCPCB has been weird about ground fills on dense boards recently, and Ill want to avoid that.\nHow far should the keepout go, then? The 5L rule (five trace widths away) is a good one, or you can just keepout the entire area where youre pulling the differential pairs. For us, 5L means 5 * 0.135 mm, or 0.685 mm distance between the pair/via and the ground fill. The 5L rule isnt a hard limit  keep to it as much as possible, but dont stress about having a few vias here and there. Remember, when wiring up PCIe, its important that the string is wet.\nFor power wires, use your thickest traces possible wherever you have space. Of course, you dont need to pull a 2 mm track wherever you want to put 3.3 V, but having 0.6 mm or 1 mm tracks on a 3.3 V 1 A path is pretty ordinary  some will say its overkill, but if you have enough space, theres hardly a benefit to not doing it. If youre wondering what you can get away with, there are trace width calculators that will give you temperature increase and inductance values, but most of the time, making the trace thicker is a no-brainer.\nAfter we wire up PCIe and power signals, there are a few things left. It might be tempting to route them on the inner ground layers  do your best to fight the temptation, however, as theres usually a better way; having unbroken inner planes is widely accepted to be good mojo for diffpairs, and for signals in general. Instead, consider other nonstandard options that are less of a sin  for instance, its okay to remove solder pads from a footprint if the pad is unused, and thats what Im going to do to pull one of the PERST signals through the top layer.\nMistakes And Problems\nIn many aspects, this design hits the bullseye. Its compact, it fits everything it should fit with space to spare, and the onboard power delivery is more than reasonable. Of course, there are a few possible hiccups I can foresee happening that I will check for once these boards are manufactured.\nA PCIe switch functions at high speeds, so it makes sense that power consumption could be a bit harsh, and same would go for heat dissipation  indeed, you will see higher-port-count chips like these covered with glued-on heatsinks on Chinese adapters; My main concern is power consumption  a M.2 E-key card is expected to consume 2 A at most, and the peak power consumption of the switch, together with the inserted card itself, might exceed this budget for sure.\nTo solve that, Im adding a separate power input, and drawing traces in a way that, if needed, its easy to separate the 1.2V\u00a0 regulator 3.3 V input from the E-key card power. My second concern about the power consumption, however, is thermal dissipation  there isnt much thermal mass in this PCB, and the ground path isnt too straightforward, so the chip could theoretically overheat under load. There wouldnt really be place for a heatsink once the adapters plugged into a laptop, either  well see just how much of a problem this is in practice.\nEvery board can be a small experiment, and this ones definitely got a few things Ive never tried before. Ive added this board to my last PCB order, and once it arrives, Ill share the end result with you all, one way or another. Until then, the files are on GitHub, and I hope that this boards story gives you plenty of insights into designing with PCIe!"}