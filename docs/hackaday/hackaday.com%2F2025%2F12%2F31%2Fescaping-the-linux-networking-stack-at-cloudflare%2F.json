{"pubDate": "2025-12-31T19:30:40", "original_title": "Escaping the Linux Networking Stack at Cloudflare", "link": "https://hackaday.com/2025/12/31/escaping-the-linux-networking-stack-at-cloudflare/", "source": "https://hackaday.com/blog/feed/", "thumbnail": "https://hackaday.com/wp-content/uploads/2025/10/Linux_netfilter_connection_table_cloudflare.png", "original_content": "Courtesy of the complex routing and network configurations that Cloudflare uses, their engineers like to push the Linux network stack to its limits and ideally beyond. In a blog article [Chris Branch] details how they ran into limitations while expanding their use of soft-unicast functionality that fits with their extensive use of anycast to push as much redundancy onto the external network as possible.\nThe particular issue that they ran into had to do with the Netfilter connection tracking (conntrack) module and the Linux socket subsystem when you use packet rewriting. For soft-unicast it is important that multiple processes are aware of the same connection, yet due to how Linux works this made it impossible to use packet rewriting. Instead they had to use a local proxy initially, but this creates overhead.\nTo work around this the solution appeared to be to abuse the TCP_REPAIR socket option in Linux, which normally exists to e.g. migrate VM network connections. This enables one to describe the entire socket connection state, thus repairing it. Combined with TCP Fast Open to skip the whole handshake bit with a TFO cookie. This still left a few more issues to fix, with an early demux providing a potential solution.\nIronically, ultimately it was decided to not break the Linux networking stack that much and stick with the much less complicated local proxy to terminate TCP connections and redirect traffic to a local socket. Unfortunately escaping the Linux networking stack isnt that straightforward.", "title": "Linux\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30b9\u30bf\u30c3\u30af\u306e\u9650\u754c\u306b\u6311\u3080Cloudflare", "body": "Cloudflare\u304cLinux\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30b9\u30bf\u30c3\u30af\u306e\u9650\u754c\u306b\u6311\u6226\u3002\u30bd\u30d5\u30c8\u30e6\u30cb\u30ad\u30e3\u30b9\u30c8\u3067\u306e\u5236\u7d04\u3092\u89e3\u6c7a\u3059\u308b\u305f\u3081\u3001TCP_REPAIR\u3092\u4f7f\u7528\u3057\u5c40\u6240\u30d7\u30ed\u30ad\u30b7\u3092\u9078\u629e\u3002", "titles": ["Linux\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30b9\u30bf\u30c3\u30af\u306e\u9650\u754c\u306b\u6311\u3080Cloudflare", "\u30bd\u30d5\u30c8\u30e6\u30cb\u30ad\u30e3\u30b9\u30c8\u6a5f\u80fd\u62e1\u5f35\u306b\u304a\u3051\u308bNetfilter\u306e\u8ab2\u984c", "TCP_REPAIR\u30bd\u30b1\u30c3\u30c8\u30aa\u30d7\u30b7\u30e7\u30f3\u306e\u6d3b\u7528\u6cd5", "\u30d7\u30ed\u30ad\u30b7\u3092\u4ecb\u3057\u305fTCP\u63a5\u7d9a\u306e\u7ba1\u7406\u65b9\u6cd5", "Linux\u30cd\u30c3\u30c8\u30ef\u30fc\u30af\u30b9\u30bf\u30c3\u30af\u3092\u7528\u3044\u305f\u5197\u9577\u6027\u306e\u6700\u9069\u5316"]}